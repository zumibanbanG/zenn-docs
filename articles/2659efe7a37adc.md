---
title: "Pythonã§ã„ã„æ„Ÿã˜ã®ã€ŒHello World !ã€ ~grpcç·¨~"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python","åˆå¿ƒè€…","tech"]
published: false
---

# 0. å¯¾è±¡èª­è€…
1å¹´å‰ã®è‡ªåˆ†ã«å‘ã‘ã¦æ›¸ãã¤ã‚‚ã‚Šã§æ›¸ãã¾ã™ï¼

# 1. ã¯ã˜ã‚ã«
ã¯ã˜ã‚ã¾ã—ã¦ï¼ãªãŠãšã¿ã¨ç”³ã—ã¾ã™ï¼
ZennåˆæŠ•ç¨¿ãªã®ã§ã€ã¾ãšã¯ã“ã“ã‹ã‚‰ã£ã¦ã“ã¨ã§ã€ã€ŒHello Worldã€ã‹ã‚‰å§‹ã‚ã¾ã™ã€œ
æœ€è¿‘grpcåˆã‚ã¦è§¦ã£ãŸã®ã§ä½¿ã£ã¦ã¿ã‚‹ï¼æ¬¡ã¯fastAPIã§ã‚„ã‚ã†ã‹ãªã€œ

# 2. ä»Šå›ã‚„ã‚‹ã“ã¨
ä»Šå›ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ä»¥ä¸‹ã®é€šã‚Š
- grpc
- poetry
- Docker
- pytest

# 3. å‰æ
- é–‹ç™ºç’°å¢ƒã¯Mac
- Dockerå…¥ã£ã¦ã‚‹ã“ã¨
- poetryå…¥ã£ã¦ã‚‹ã“ã¨

# 4. poetryã§æ–°ã—ããƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œã‚‹
```sh
poetry new grpc
```

# 5. å¿…è¦ãªã‚‚ã®ã‚’è¿½åŠ ã—ã¦ã„ã
```sh
poetry add grpcio
poetry add grpcio-tools
poetry add pytest
```

# 6. protoãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€grpcã‚³ãƒ¼ãƒ‰ã®ä½œæˆ
protoãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€åŸºæœ¬çš„ã«å…¬å¼ã®ã‚„ã¤ã‚’ä¸¸ã±ãã‚Šã—ã¦ã€protoãƒ•ã‚¡ã‚¤ãƒ«ã®versionã ã‘è¿½åŠ ã™ã‚‹ã€‚
```proto:hello_world.proto
syntax = "proto3";

service Greeter {
  rpc SayHello (HelloRequest) returns (HelloReply) {}
  rpc SayHelloAgain (HelloRequest) returns (HelloReply) {}
}

message HelloRequest {
  string name = 1;
}

message HelloReply {
  string message = 1;
}
```
æ¬¡ã«ã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã—ã¦ã€grpcã‚³ãƒ¼ãƒ‰ã®ä½œæˆã€‚
```sh
poetry run python -m grpc_tools.protoc -I ./proto \
--python_out=./src/pb \
--pyi_out=./src/pb \
--grpc_python_out=./src/pb \
./proto/hello_world.proto
```
ä½œæˆå®Œäº†ã™ã‚‹ã¨ã€ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¯ã“ã‚“ãªæ„Ÿã˜
```
.
â”œâ”€â”€ README.md
â””â”€â”€ grpc
    â”œâ”€â”€ README.md
    â”œâ”€â”€ poetry.lock
    â”œâ”€â”€ proto
    â”‚   â””â”€â”€ hello_world.proto
    â”œâ”€â”€ pyproject.toml
    â”œâ”€â”€ src
    â”‚   â”œâ”€â”€ grpc
    â”‚   â”‚   â””â”€â”€ __init__.py
    â”‚   â””â”€â”€ pb
    â”‚       â”œâ”€â”€ hello_world_pb2.py
    â”‚       â”œâ”€â”€ hello_world_pb2.pyi
    â”‚       â””â”€â”€ hello_world_pb2_grpc.py
    â””â”€â”€ tests
        â””â”€â”€ __init__.py
```
pbãƒ•ã‚©ãƒ«ãƒ€ã«ä»¥ä¸‹ã®__init__.pyã‚’è¿½åŠ ã—ã¦pathã‚’é€šã™
```py:__init__.py
import sys
from pathlib import Path

sys.path.append(str(Path(__file__).parent))
```

# 7. ã‚µãƒ¼ãƒã®ç«‹ã¡ä¸Šã’
grpcã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€
```py:server.py
from concurrent import futures
import grpc
from pb import hello_world_pb2_grpc
from pb import hello_world_pb2


class Greeter(hello_world_pb2_grpc.GreeterServicer):

    def SayHello(self, request, context):
        return hello_world_pb2.HelloReply(message=f"Hello, {request.name}!")

    def SayHelloAgain(self, request, context):
        return hello_world_pb2.HelloReply(message=f"Hello again, {request.name}!")


def serve():
    server = grpc.server(futures.ThreadPoolExecutor(max_workers=10))
    hello_world_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)
    server.add_insecure_port("[::]:50051")
    server.start()
    print("Server started on port 50051")
    server.wait_for_termination()


if __name__ == "__main__":
    serve()
```
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼ã‚’ç«‹ã¡ä¸Šã’ã‚‹
```sh
poetry run python ./src/grpc/server.py
```
çµæœç¢ºèªâ†’è‰¯ã•ã~
```
Server started on port 50051
```

# 8. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ç«‹ã¡ä¸Šã’
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ã€
```py:client.py
import grpc
from pb import hello_world_pb2
from pb import hello_world_pb2_grpc


def run():
    with grpc.insecure_channel("localhost:50051") as channel:
        stub = hello_world_pb2_grpc.GreeterStub(channel)
        response = stub.SayHello(hello_world_pb2.HelloRequest(name="naozumi"))
        print("Greeter client received: " + response.message)
        response = stub.SayHelloAgain(hello_world_pb2.HelloRequest(name="naozumi"))
        print("Greeter client received: " + response.message)


if __name__ == "__main__":
    run()
```
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚µãƒ¼ãƒãƒ¼å©ã„ã¦ã¿ã‚‹
```sh
poetry run python ./src/grpc/client.py
```
çµæœç¢ºèªâ†’è‰¯ã•ãã€œ
```
Greeter client received: Hello, naozumi!
Greeter client received: Hello again, naozumi!
```

# 9. Dockerã«ã¾ã¨ã‚ã‚‹
Dockerã§å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ã€Dockerfileã‚’ä½œæˆã™ã‚‹
```Dockerfile:Dockerfile
FROM public.ecr.aws/docker/library/python:3.13.0-slim-bookworm

WORKDIR /app

COPY pyproject.toml poetry.lock ./

ENV POETRY_REQUESTS_TIMEOUT=10800

RUN python -m pip install --upgrade pip && \
    pip install poetry --no-cache-dir && \
    poetry config virtualenvs.create false && \
    poetry install --no-interaction --no-ansi --no-root && \
    poetry cache clear --all pypi
    
COPY src /app/src

CMD ["poetry", "run", "python", "src/grpc/server.py"]

EXPOSE 50051
```
ãã®ã¾ã¾ã ã¨ã€ModuleImportã§ã“ã‘ã¦å‹•ã‹ãªã„ã®ã§ã€server.pyã§pathã‚’é€šã™
```py:server.py
from concurrent import futures
import grpc

# ä»¥ä¸‹ãŒè¿½åŠ ã—ãŸã¨ã“
import sys
sys.path.append("./src")

from pb import hello_world_pb2_grpc
from pb import hello_world_pb2
```
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§å‹•ä½œç¢ºèª
```sh
docker build -t grpc .
docker run -d -p 50051:50051 grpc
```
ä¸€å¿œãƒªã‚¯ã‚¨ã‚¹ãƒˆæŠ•ã’ã¦ã¿ã‚‹
```sh
poetry run python ./src/grpc/client.py
```
çµæœç¢ºèªâ†’è‰¯ã•ãã€œ
```sh
Greeter client received: Hello, naozumi!
Greeter client received: Hello again, naozumi!
```
åŸºæœ¬çš„ãªã®ã¯ã€ã“ã“ã¾ã§ï¼
ã“ã£ã‹ã‚‰ã¯ã€ãƒ†ã‚¹ãƒˆã¨ã‹ã€CICDã¨ã‹ã‚„ã£ã¦ã„ãï¼

# 10. testã‚³ãƒ¼ãƒ‰ã®ä½œæˆ
pytest-grpcã‚’è¿½åŠ ã™ã‚‹ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯ä½¿ã‚ãªã„ã®ã§ã€--devã¤ã‘ã¦ã€‚
```sh
poetry add --dev pytest-grpc
```
testã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã™ã‚‹
æƒ³å®šé€šã‚Šã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ãã‚‹ã‹ã©ã†ã‹ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã ã‘ã‹ãã€œ
```py:test_server.py
import pytest
from src.pb import hello_world_pb2
from src.pb import hello_world_pb2_grpc
from src.grpc.server import Greeter


@pytest.fixture(scope="module")
def grpc_add_to_server():
    return hello_world_pb2_grpc.add_GreeterServicer_to_server


@pytest.fixture(scope="module")
def grpc_servicer():
    return Greeter()


@pytest.fixture(scope="module")
def grpc_stub(grpc_channel):
    return hello_world_pb2_grpc.GreeterStub(grpc_channel)


def test_say_hello(grpc_stub):
    response = grpc_stub.SayHello(hello_world_pb2.HelloRequest(name="test user"))
    assert response.message == "Hello, test user!"


def test_say_hello_again(grpc_stub):
    response = grpc_stub.SayHelloAgain(hello_world_pb2.HelloRequest(name="test user"))
    assert response.message == "Hello again, test user!"
```
ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’èµ°ã‚‰ã›ã‚‹
```sh
poetry run pytest
```
çµæœç¢ºèªâ†’è‰¯ã•ãã€œ
```sh
================================================================== test session starts ==================================================================
platform darwin -- Python 3.13.2, pytest-8.3.5, pluggy-1.5.0
rootdir: ~/grpc
configfile: pyproject.toml
plugins: grpc-0.8.0
collected 2 items                                                                                                                                       

tests/test_server.py ..                                                                                                                           [100%]

=================================================================== 2 passed in 0.04s ===================================================================
```

# ã¾ã¨ã‚
ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿï¼Ÿ
ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚‚è¼‰ã›ã‚‹ã®ã§è‰¯ã‹ã£ãŸã‚‰è¦—ã„ã¦ãã ã•ã„ï¼
ä»Šå›ã¯grpcã§ã®hello worldã§ã—ãŸãŒã€fastapiã¨ã‹ã‚‚è¨˜äº‹ã«ã—ã‚ˆã†ã‹ã¨æ€ã„ã¾ã™ã€œ
èª°ã‹ã®ä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€œ

https://github.com/zumibanbanG/python_hello_world

