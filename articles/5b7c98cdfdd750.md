---
title: "Claude + MCP + BigQueryMLã§ã€ã‚¿ã‚¤ã‚¿ãƒ‹ãƒƒã‚¯ç”Ÿå­˜äºˆæ¸¬"
emoji: "ğŸ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["python","bigquery", "mcp", "fastapi", "æ©Ÿæ¢°å­¦ç¿’"]
published: true
---

# 0. å¯¾è±¡èª­è€…
ã€ŒMCPè§¦ã£ã¦ã¿ã‚ˆã†ã€ã£ã¦ã„ã†Pythonãƒ¦ãƒ¼ã‚¶

# 1. ã¯ã˜ã‚ã«
ã“ã‚“ã«ã¡ã¯ï¼ãªãŠãšã¿ã§ã™ï¼
æœ¬è¨˜äº‹ã¯å‰å›æ›¸ã„ãŸä»¥ä¸‹ã®è¨˜äº‹ã®ãŠã¾ã‘ã«ãªã‚Šã¾ã™ã€‚
ã¾ã è¦‹ã¦ãªã„æ–¹ã¯ãã£ã¡ã‹ã‚‰è¦‹ã¦ã‚‚ã‚‰ãˆã‚‹ã¨å¬‰ã—ã„ã§ã™ï¼
https://zenn.dev/naozumi23/articles/1ad57b29affc46
å‰å›ã€è‡ªç„¶è¨€èªã§BigQueryã‚’è§¦ã£ã¦ã¿ã¾ã—ãŸãŒã€ä»Šå›ã¯BigQueryMLã‚’ä½¿ã£ã¦ã€ç°¡å˜ãªç”Ÿå­˜äºˆæ¸¬ã‚’ã‚„ã£ã¦ã¿ã¾ã—ãŸã€‚

# 2. ä»Šå›ã‚„ã‚‹ã“ã¨
ä»Šå›ã®ã‚¹ã‚³ãƒ¼ãƒ—ã¯ä»¥ä¸‹ã®é€šã‚Š
- claude desktop
- fastapi-mcp
- poetry
- Docker
- pytest

# 3. å‰æ
- é–‹ç™ºç’°å¢ƒã¯Mac
- Dockerå…¥ã£ã¦ã‚‹ã“ã¨
- poetryå…¥ã£ã¦ã‚‹ã“ã¨
- uvå…¥ã£ã¦ã‚‹ã“ã¨
- Claude Desktopå…¥ã£ã¦ã‚‹ã“ã¨(ç„¡æ–™ãƒ—ãƒ©ãƒ³ã§å¤§ä¸ˆå¤«)

# 4. BigQueryMLãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã€server.pyã«è¿½è¨˜
ç·šå½¢å›å¸°ã®æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ã™ã‚‹APIã¨ã€æ¨è«–ã™ã‚‹APIã®2ã¤ã‚’è¿½è¨˜ã™ã‚‹
```py:server.py
@app.get("/create_logistic_reg_model_by_bigquery_ml/{model_name}/{project_id}/{dataset_id}/{train_table_id}/{target_variable}", operation_id="create_logistic_reg_model_by_bigquery_ml")
async def create_logistic_reg_model_by_bigquery_ml(model_name: str, project_id: str, dataset_id: str, train_table_id: str, target_variable: str):
    
    # Execute the query
    query = f"""
        CREATE OR REPLACE MODEL `{project_id}.{dataset_id}.{model_name}`
        OPTIONS(
          model_type='logistic_reg'
        ) AS
        SELECT
          {target_variable} as label,
          * except({target_variable})
        FROM
          `{project_id}.{dataset_id}.{train_table_id}`
    """
    
    query_job = client.query(query)
    # Wait for the job to complete
    query_job.result()
    
    return {"model_name": model_name, "status": "Model created successfully"}

@app.get("/predict_by_bigquery_ml/{model_name}/{project_id}/{dataset_id}/{test_table_id}/{id}/{limit}", operation_id="predict_by_bigquery_ml")
async def predict_by_bigquery_ml(model_name: str, project_id: str, dataset_id: str, test_table_id: str, id: str, limit: int):

    # Execute the query
    query = f"""
        SELECT
            {id} as id,
            predicted_label
        FROM
            ML.PREDICT(MODEL `{project_id}.{dataset_id}.{model_name}`, (
            SELECT
                *
            FROM
                `{project_id}.{dataset_id}.{test_table_id}`
            ))
        ORDER BY
            id
        LIMIT {limit}
    """
    
    query_job = client.query(query)
    # Wait for the job to complete
    results = query_job.result()
    
    return {"predictions": [dict(row) for row in results]}
```
BigQueryMLã¯ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ãªã©ã®ãƒ¢ãƒ‡ãƒ«ã ã¨ã€å‹æ‰‹ã«OneHotEncodingã—ã¦ãã‚Œã‚‹ã®ã§ã€ç›®çš„å¤‰æ•°ä»¥å¤–ã¯å…¨éƒ¨ç‰¹å¾´é‡ã¨ã—ã¦çªã£è¾¼ã‚“ã˜ã‚ƒã†ã€‚
å…¨éƒ¨ã®ãƒ‡ãƒ¼ã‚¿ã ã¨æ™‚é–“ã‹ã‹ã£ã¡ã‚ƒã†ã®ã§ã€limitã‚‚ã¤ã‘ã¨ãã€‚

# 5. Claude Desktopã‹ã‚‰è§¦ã£ã¦ã¿ã‚‹
![alt text](/images/image001_5b7c98cdfdd750.png)
5ä»¶äºˆæ¸¬ã—ãŸæ„Ÿã˜ã¯ä»¥ä¸‹ã®é€šã‚Š
```json
{
  "predictions": [
    {
      "id": 892,
      "predicted_label": 0
    },
    {
      "id": 893,
      "predicted_label": 0
    },
    {
      "id": 894,
      "predicted_label": 0
    },
    {
      "id": 895,
      "predicted_label": 0
    },
    {
      "id": 896,
      "predicted_label": 1
    }
  ]
}
```
![alt text](/images/image002_5b7c98cdfdd750.png)

# 5. ã¾ã¨ã‚
ã„ã‹ãŒã ã£ãŸã§ã—ã‚‡ã†ã‹ï¼Ÿ
BigQueryMLã‚’è‡ªç„¶è¨€èªã§è§¦ã£ã¦ã¿ã¾ã—ãŸãŒã€ç°¡æ˜“çš„ãªäºˆæ¸¬ã§ã‚ã‚Œã°ä½¿ãˆãã†ã§ã™ã­ã€‚
æ©Ÿæ¢°å­¦ç¿’ã®ãƒŠãƒ¬ãƒƒã‚¸ãŒãªãã¦ã‚‚ã€ã–ã£ãã‚Šäºˆæ¸¬ã§ãã‚‹ï¼ã¿ãŸã„ãªã®ã¯ã€ãã“ãã“éœ€è¦ã‚ã‚‹ã‚“ã˜ã‚ƒãªã„ã‹ãªã€œã¦æ€ã£ã¦ã¾ã™ã€‚
MCPã¨ã£ã¦ã‚‚é¢ç™½ã„ã®ã§ä»–ã«ã‚‚è‰²ã€…è©¦ã—ã¦ã¿ãŸã„ã§ã™ã­ï¼